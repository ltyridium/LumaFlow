# LumaFlow
本项目（LumaFlow）是一个纯粹的技术研究项目，专注于灯光控制数据的可视化算法与编辑器逻辑开发。

1. **研究属性**：本项目旨在探索灯光效果的编排以及。
2. **数据来源说明**：仓库内提供的 .csv 示例文件仅作为算法验证样本学习使用。这些样本通过特定的信号捕获实验获得，仅用于展示软件的数据渲染能力。
3. **非商用承诺**：本项目及相关样本数据**严禁用于任何商业目的**，也不代表任何实际商业演出的完整技术方案。
4. **版权保护**：样本数据中涉及的任何原创编排设计归原权利人所有。若权利人认为相关样本的使用不当，请联系移除测试样本。

*This project is for academic and educational purposes only. The provided CSV samples are for algorithm verification and visualization testing. No commercial use is intended or permitted.*

**Note on Data**: The code in this repository is licensed under [GPL], but the .csv sample files are provided only for testing and are not covered by this license.



## 目录

- [项目概述](#项目概述)
- [功能特性](#功能特性)
- [系统要求](#系统要求)
- [安装指南](#安装指南)
- [快速开始](#快速开始)
- [用户界面](#用户界面)
- [快捷键参考](#快捷键参考)
- [数据格式](#数据格式)
- [光效生成](#光效生成)
- [音频可视化](#音频可视化)
- [架构设计](#架构设计)

---

## 项目概述

LumaFlow 是一款专为 LED 灯光效果设计的时间轴编辑器。它支持：

- **10通道 LED 控制**：每个通道具有独立的 RGB 颜色（4位，0-15）和功能模式
- **视频同步**：通过 VLC 播放器实现视频与灯光时间轴的精确同步
- **音频波形显示**：可视化音频频谱，辅助灯光节拍同步
- **双时间轴系统**：源时间轴（只读参考）+ 编辑时间轴（主工作区）
- **完整的撤销/重做系统**：所有编辑操作均可撤销
- **CSV 数据格式**：易于导入导出的开放格式

---

## 功能特性

### 核心编辑功能
- 剪切、复制、粘贴、删除帧数据
- 插入黑屏帧、彩色帧
- 添加和编辑时间标记
- 区域偏移（时间平移）
- 生成呼吸效果和彩虹流光效果

### 时间轴功能
- 高性能渲染，支持海量帧数据
- 智能数据聚合（缩小视图时自动降采样）
- 帧吸附功能（自动对齐到最近关键帧）
- 区域选择和编辑
- 标记系统（可双击编辑）

### 视频与音频
- 双视频预览窗口（源预览 + 编辑预览）
- VLC 播放器集成
- 音频频谱可视化（Mel 频谱图）
- 视频与时间轴同步播放

### 界面特性
- 可停靠面板系统（参考 Adobe Premiere Pro 布局）
- 深色/浅色主题切换
- 窗口状态保存与恢复
- 数据表格查看器

---

## 系统要求

### 必需组件
- Python 3.10+
- VLC Media Player（系统安装）
- FFmpeg（用于音频提取，可选但推荐）

### Python 依赖
```
PySide6>=6.5.0
pandas>=2.0.0
numpy>=1.24.0
pyserial>=3.5
python-vlc>=3.0.0
pyqtgraph>=0.13.0
numba>=0.57.0
librosa>=0.10.0
soundfile>=0.12.0
matplotlib>=3.7.0
```

---

## 安装指南

### 1. 安装 VLC Media Player
从 [VLC 官网](https://www.videolan.org/vlc/) 下载并安装 VLC。

### 2. 安装 Python 依赖
```bash
cd chroma_keyframer
pip install -r requirements.txt
```

### 3. 运行应用程序
```bash
python main.py
```

---

## 快速开始

### 创建新项目
1. 点击 **文件 → 新建编辑...** 或按 `Ctrl+N`
2. 输入项目时长（秒）
3. 开始编辑

### 打开现有项目
1. 点击 **文件 → 打开编辑...** 或按 `Ctrl+O`
2. 选择 CSV 文件

### 导入参考素材
1. 点击 **文件 → 打开源...** 加载源 CSV 数据
2. 点击工具栏的 **导入源视频** 或 **导入编辑视频**

### 基本编辑流程
1. 在时间轴上点击定位播放头
2. 拖动创建选区
3. 使用快捷键或菜单执行编辑操作
4. `Ctrl+S` 保存

---

## 用户界面

### 主窗口布局

```
┌─────────────────────────────────────────────────────────────────┐
│  菜单栏  │  文件  编辑  视图  时间轴  音频                       │
├─────────────────────────────────────────────────────────────────┤
│  工具栏  │ 新建 打开 保存 │ 撤销 重做 │ 剪切 复制 粘贴 │ ...   │
├──────────────────┬──────────────────────────────────────────────┤
│                  │                                              │
│   源视频预览     │            源时间轴（Source Monitor）         │
│                  │                                              │
├──────────────────┼──────────────────────────────────────────────┤
│                  │                                              │
│  编辑视频预览    │           编辑时间轴（Master Sequence）       │
│                  │                                              │
├──────────────────┴──────────────────────────────────────────────┤
│                        数据表格视图                              │
└─────────────────────────────────────────────────────────────────┘
```

### 时间轴视图

- **CH0-CH9**：10个 LED 通道，显示颜色块
- **MARK**：标记通道，显示时间标记
- **IDX**：索引通道，显示播放头和选区指示器
- **红色竖线**：播放头位置
- **蓝色区域**：选中区域

### 可停靠面板
- **Source Monitor**：源时间轴（默认隐藏）
- **Source Preview**：源视频预览（默认隐藏）
- **Program Preview**：编辑视频预览
- **Data Table**：数据表格视图

通过 **视图** 菜单可以显示/隐藏各个面板。

---

## 快捷键参考

### 文件操作
| 快捷键 | 功能 |
|--------|------|
| `Ctrl+N` | 新建编辑项目 |
| `Ctrl+O` | 打开编辑文件 |
| `Ctrl+S` | 保存 |
| `Ctrl+Shift+S` | 另存为 |

### 编辑操作
| 快捷键 | 功能 |
|--------|------|
| `Ctrl+Z` | 撤销 |
| `Ctrl+Y` / `Ctrl+Shift+Z` | 重做 |
| `Ctrl+X` | 剪切选区 |
| `Ctrl+C` | 复制选区 |
| `Ctrl+V` | 粘贴到播放头位置 |
| `Delete` | 删除选区 |
| `Ctrl+A` | 全选 |
| `Ctrl+Shift+D` | 取消选择 |

### 时间轴导航
| 快捷键 | 功能 |
|--------|------|
| `←` / `→` | 移动播放头 ±10ms |
| `Shift+←` / `Shift+→` | 移动播放头 ±100ms |
| `Alt+←` / `Alt+→` | 跳转到上/下一个标记 |
| `Home` | 跳转到时间轴起点 |
| `End` | 跳转到时间轴终点 |
| `Page Up` / `Page Down` | 移动半个视图宽度 |
| `J` | 跳转到鼠标位置 |

### 视图缩放
| 快捷键 | 功能 |
|--------|------|
| `+` / `=` | 放大 |
| `-` | 缩小 |
| `F` | 适应视图（选区或全局） |
| `\` | 适应全部数据到视图 |
| `滚轮` | 水平缩放 |
| `Shift+滚轮` | 水平滚动 |
| `Ctrl+滚轮` | 以鼠标位置为中心缩放 |
| `Alt+滚轮` | 音频轨道垂直缩放 |

### 插入操作
| 快捷键 | 功能 |
|--------|------|
| `B` | 插入黑屏帧 |
| `W` | 插入白色帧 |
| `R` | 插入红色帧 |
| `G` | 插入绿色帧 |
| `I` | 插入自定义颜色帧（弹出对话框） |
| `M` | 添加标记（弹出对话框） |
| `E` | 编辑当前帧（±50ms 内最近的帧） |

### 区域偏移
| 快捷键 | 功能 |
|--------|------|
| `Shift+M` | 指定偏移量对话框 |
| `Ctrl+[` | 选区左移 100ms |
| `Ctrl+]` | 选区右移 100ms |

### 播放控制
| 快捷键 | 功能 |
|--------|------|
| `空格` | 播放/暂停视频 |

### 鼠标操作
| 操作 | 功能 |
|------|------|
| 左键点击 | 定位播放头 |
| 左键拖动 | 创建选区 |
| Shift+左键 | 扩展选区 |
| Ctrl+左键拖动（选区内） | 偏移选区数据 |
| 中键拖动 | 平移视图 |
| 右键点击 | 上下文菜单 |
| 双击标记 | 编辑标记名称 |

---

## 数据格式

### CSV 文件结构

LumaFlow 使用 CSV 格式存储灯光序列数据：

| 列名 | 类型 | 描述 |
|------|------|------|
| `frame_time_ms` | float | 帧时间戳（毫秒） |
| `frame_id` | int | 顺序帧编号 |
| `frame_type` | string | 帧类型（blackout, color, breathing, rainbow 等） |
| `marker` | string | 可选的时间标记名称 |
| `ch{N}_function` | int | 通道 N 的功能码（0-3） |
| `ch{N}_red` | int | 通道 N 的红色值（0-15） |
| `ch{N}_green` | int | 通道 N 的绿色值（0-15） |
| `ch{N}_blue` | int | 通道 N 的蓝色值（0-15） |

其中 `N` 为通道编号 0-9。

### 功能码说明
| 功能码 | 描述 |
|--------|------|
| 0 | 常亮（静态颜色） |
| 1 | 1Hz 频闪 |
| 2 | 2Hz 频闪 |
| 3 | 4Hz 频闪 |

### 颜色值
- 取值范围：0-15（4位）
- 实际 RGB 值：乘以 17 得到 0-255 范围
- 例如：`r=15, g=8, b=0` → RGB(255, 136, 0)

---

## 光效生成

### 呼吸效果（Breathing Effect）

通过 **时间轴 → 生成 → 生成呼吸效果** 打开对话框。

参数：
- **Duration (ms)**：效果总时长
- **Interval (ms)**：帧间隔（默认 100ms）
- **Color**：基础颜色
- **Min Brightness**：最小亮度（0.0-1.0）
- **Max Brightness**：最大亮度（0.0-1.0）

呼吸效果使用正弦波调制亮度，产生渐变效果。

### 彩虹流光效果（Rainbow Effect）

通过 **时间轴 → 生成 → 生成彩虹效果** 打开对话框。

参数：
- **Duration (ms)**：效果总时长
- **Interval (ms)**：帧间隔（默认 100ms）
- **Speed**：颜色变化速度

彩虹效果在 HSV 色彩空间中循环变换，10个通道呈现相位偏移的彩虹效果。

---

## 音频可视化

### 概述

LumaFlow 可以从视频中提取音频并显示 Mel 频谱图，帮助您将灯光效果与音乐节拍同步。

### 启用音频可视化

1. 导入视频文件
2. 音频将自动提取和处理
3. 频谱图显示在时间轴下方

### 音频设置

通过 **音频 → 音频可视化设置...** 打开设置对话框。

可配置项：
- **声道模式**：单声道、立体声、左声道、右声道
- **频率范围**：最低/最高频率（Hz）
- **色彩映射**：频谱显示的配色方案
- **显示高度**：音频轨道的高度

### 技术参数

- **采样率**：44100 Hz
- **FFT 窗口**：2048 samples
- **跳跃长度**：1024 samples
- **Mel 频带数**：128
- **默认频率范围**：20-8000 Hz

---

## 架构设计

### 整体架构

LumaFlow 采用 MVC 风格的架构：

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│    main.py  │────▶│  app_logic  │────▶│   managers  │
│   (入口)    │     │  (控制器)   │     │  (业务逻辑) │
└─────────────┘     └──────┬──────┘     └─────────────┘
                           │
                    ┌──────▼──────┐
                    │  MainWindow │
                    │    (UI)     │
                    └─────────────┘
```

### 核心模块

#### `app_logic.py` - 应用控制器
- 连接 UI 和业务逻辑
- 处理所有用户操作
- 协调各个 Manager

#### `core/data_manager.py` - 数据管理器
- CSV 文件加载和保存
- 时间轴数据操作（粘贴、删除、分段）
- 数据完整性验证

#### `core/undo_manager.py` - 撤销管理器
- 命令模式实现
- 支持的命令：Cut, Copy, Paste, Delete, Offset, InsertFrame, InsertEffect, AddMarker, UpdateFrame

#### `core/effects.py` - 光效生成器
- 呼吸效果生成
- 彩虹效果生成
- 使用 Numba JIT 加速

#### `core/audio_manager.py` - 音频管理器
- 音频提取（通过 FFmpeg）
- Mel 频谱图计算（通过 librosa）
- 瓦片缓存系统

#### `core/clipboard_manager.py` - 剪贴板管理器
- 存储复制/剪切的帧数据
- 跟踪数据来源（source/edit）

### UI 模块

#### `ui/main_window.py` - 主窗口
- 菜单栏和工具栏
- Dock 布局管理
- 信号连接

#### `ui/timeline_widget.py` - 时间轴组件
- 基于 PyQtGraph 的高性能渲染
- 自定义图形项（FastScatterItem, MarkerItem 等）
- 后台渲染线程

#### `ui/timeline_tools.py` - 时间轴工具
- 工具状态机模式
- SelectionTool：选择和编辑
- HandTool：平移视图

#### `ui/dialogs.py` - 对话框
- EffectDialog：光效参数配置
- ColorPickerDialog：颜色选择器

#### `ui/video_player_widget.py` - 视频播放器
- VLC 播放器封装
- 播放控制
- 时间同步

#### `ui/audio_track_widget.py` - 音频轨道
- 频谱图显示
- 与时间轴同步缩放

### 性能优化

- **后台渲染**：时间轴渲染在独立线程执行
- **数据聚合**：缩小视图时自动降采样，保持帧率
- **瓦片缓存**：音频频谱图分块缓存
- **Numba JIT**：光效生成使用 JIT 编译加速
- **批量操作**：数据操作使用向量化 Pandas 操作

---

## 主题

LumaFlow 支持深色和浅色两种主题：

- **深色主题**：通过 **视图 → Dark Theme** 启用
- **浅色主题**：通过 **视图 → Light Theme** 启用

主题文件位于 `resources/styles/` 目录。



## 问题反馈

